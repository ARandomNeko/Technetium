"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.adapter = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const child_process_1 = require("child_process");
const esbuild = __importStar(require("esbuild"));
const dotenv_1 = require("dotenv");
const fs_1 = require("fs");
const updateDotenv = require('update-dotenv');
function adapter({ artifactPath = 'build', autoDeploy = false, cdkProjectPath = `${__dirname}/deploy/index.js`, stackName = 'sveltekit-adapter-aws-webapp', esbuildOptions = {}, FQDN, LOG_RETENTION_DAYS, MEMORY_SIZE, env = {}, } = {}) {
    /** @type {import('@sveltejs/kit').Adapter} */
    return {
        name: 'adapter-awscdk',
        adapt(builder) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function* () {
                const environment = (0, dotenv_1.config)({ path: (0, path_1.join)(process.cwd(), '.env') });
                (0, fs_extra_1.emptyDirSync)(artifactPath);
                const static_directory = (0, path_1.join)(artifactPath, 'assets');
                if (!(0, fs_extra_1.existsSync)(static_directory)) {
                    (0, fs_extra_1.mkdirSync)(static_directory, { recursive: true });
                }
                const prerendered_directory = (0, path_1.join)(artifactPath, 'prerendered');
                if (!(0, fs_extra_1.existsSync)(prerendered_directory)) {
                    (0, fs_extra_1.mkdirSync)(prerendered_directory, { recursive: true });
                }
                const server_directory = (0, path_1.join)(artifactPath, 'server');
                if (!(0, fs_extra_1.existsSync)(server_directory)) {
                    (0, fs_extra_1.mkdirSync)(server_directory, { recursive: true });
                }
                builder.log.minor('Copying asset files.');
                const clientFiles = yield builder.writeClient(static_directory);
                builder.log.minor('Copying server files.');
                yield builder.writeServer(artifactPath);
                (0, fs_extra_1.copyFileSync)(`${__dirname}/lambda/serverless.js`, `${server_directory}/_index.js`);
                (0, fs_extra_1.copyFileSync)(`${__dirname}/lambda/shims.js`, `${server_directory}/shims.js`);
                builder.log.minor('Building AWS Lambda server function.');
                esbuild.buildSync({
                    entryPoints: [`${server_directory}/_index.js`],
                    outfile: `${server_directory}/index.js`,
                    inject: [(0, path_1.join)(`${server_directory}/shims.js`)],
                    external: ['node:*', ...((_a = esbuildOptions === null || esbuildOptions === void 0 ? void 0 : esbuildOptions.external) !== null && _a !== void 0 ? _a : [])],
                    format: (_b = esbuildOptions === null || esbuildOptions === void 0 ? void 0 : esbuildOptions.format) !== null && _b !== void 0 ? _b : 'cjs',
                    bundle: true,
                    platform: 'node',
                    target: (_c = esbuildOptions === null || esbuildOptions === void 0 ? void 0 : esbuildOptions.target) !== null && _c !== void 0 ? _c : 'node16',
                    treeShaking: true,
                });
                builder.log.minor('Prerendering static pages.');
                const prerenderedFiles = yield builder.writePrerendered(prerendered_directory);
                builder.log.minor('Cleanup project.');
                (0, fs_extra_1.unlinkSync)(`${server_directory}/_index.js`);
                (0, fs_extra_1.unlinkSync)(`${artifactPath}/index.js`);
                builder.log.minor('Exporting routes.');
                const routes = [
                    ...new Set([...clientFiles, ...prerenderedFiles]
                        .map((x) => {
                        const z = (0, path_1.dirname)(x);
                        if (z === '.')
                            return x;
                        if (z.includes('/'))
                            return undefined;
                        return `${z}/*`;
                    })
                        .filter(Boolean)),
                ];
                (0, fs_1.writeFileSync)((0, path_1.join)(artifactPath, 'routes.json'), JSON.stringify(routes));
                builder.log.minor('Deploy using AWS-CDK.');
                autoDeploy &&
                    (0, child_process_1.spawnSync)('npx', [
                        'cdk',
                        'deploy',
                        '--app',
                        cdkProjectPath,
                        '*',
                        '--require-approval',
                        'never',
                        '--outputsFile',
                        (0, path_1.join)(__dirname, 'cdk.out', 'cdk-env-vars.json'),
                    ], {
                        cwd: __dirname,
                        stdio: [process.stdin, process.stdout, process.stderr],
                        env: Object.assign({
                            PROJECT_PATH: (0, path_1.join)(process.cwd(), '.env'),
                            SERVER_PATH: (0, path_1.join)(process.cwd(), server_directory),
                            STATIC_PATH: (0, path_1.join)(process.cwd(), static_directory),
                            PRERENDERED_PATH: (0, path_1.join)(process.cwd(), prerendered_directory),
                            ROUTES: routes,
                            STACKNAME: stackName,
                            FQDN,
                            LOG_RETENTION_DAYS,
                            MEMORY_SIZE,
                        }, process.env, env),
                    });
                try {
                    const rawData = (0, fs_extra_1.readFileSync)((0, path_1.join)(__dirname, 'cdk.out', 'cdk-env-vars.json')).toString();
                    const data = JSON.parse(rawData);
                    const out = Object.keys(data).reduce((p, n) => (Object.assign(Object.assign({}, p), Object.keys(data[n])
                        .filter((x) => !x.includes('ExportsOutput'))
                        .reduce((p, x) => {
                        p[x.toUpperCase()] = data[n][x];
                        return p;
                    }, {}))), {});
                    updateDotenv(Object.assign(Object.assign({}, environment.parsed), out));
                    (0, fs_extra_1.unlinkSync)((0, path_1.join)(__dirname, 'cdk.out', 'cdk-env-vars.json'));
                }
                catch (_d) { }
                builder.log.minor('AWS-CDK deployment done.');
            });
        },
    };
}
exports.adapter = adapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1Q0FBdUc7QUFDdkcsK0JBQXFDO0FBQ3JDLGlEQUEwQztBQUMxQyxpREFBbUM7QUFDbkMsbUNBQWdDO0FBQ2hDLDJCQUFtQztBQUNuQyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFjOUMsU0FBZ0IsT0FBTyxDQUFDLEVBQ3RCLFlBQVksR0FBRyxPQUFPLEVBQ3RCLFVBQVUsR0FBRyxLQUFLLEVBQ2xCLGNBQWMsR0FBRyxHQUFHLFNBQVMsa0JBQWtCLEVBQy9DLFNBQVMsR0FBRyw4QkFBOEIsRUFDMUMsY0FBYyxHQUFHLEVBQUUsRUFDbkIsSUFBSSxFQUNKLGtCQUFrQixFQUNsQixXQUFXLEVBQ1gsR0FBRyxHQUFHLEVBQUUsTUFDVyxFQUFFO0lBQ3JCLDhDQUE4QztJQUM5QyxPQUFPO1FBQ0wsSUFBSSxFQUFFLGdCQUFnQjtRQUNoQixLQUFLLENBQUMsT0FBWTs7O2dCQUN0QixNQUFNLFdBQVcsR0FBRyxJQUFBLGVBQU0sRUFBQyxFQUFFLElBQUksRUFBRSxJQUFBLFdBQUksRUFBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNsRSxJQUFBLHVCQUFZLEVBQUMsWUFBWSxDQUFDLENBQUM7Z0JBRTNCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBQSxXQUFJLEVBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLENBQUMsSUFBQSxxQkFBVSxFQUFDLGdCQUFnQixDQUFDLEVBQUU7b0JBQ2pDLElBQUEsb0JBQVMsRUFBQyxnQkFBZ0IsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2lCQUNsRDtnQkFFRCxNQUFNLHFCQUFxQixHQUFHLElB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RUFBRSxTQUFTLEVBQUUsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO2lCQUM3RDtnQkFBQyxXQUFNLEdBQUU7Z0JBRVYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQzs7U0FDL0M7S0FDRixDQUFDO0FBQ0osQ0FBQztBQXpJRCwwQkF5SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb3B5RmlsZVN5bmMsIHVubGlua1N5bmMsIGV4aXN0c1N5bmMsIG1rZGlyU3luYywgZW1wdHlEaXJTeW5jLCByZWFkRmlsZVN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBqb2luLCBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzcGF3blN5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCAqIGFzIGVzYnVpbGQgZnJvbSAnZXNidWlsZCc7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHsgd3JpdGVGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmNvbnN0IHVwZGF0ZURvdGVudiA9IHJlcXVpcmUoJ3VwZGF0ZS1kb3RlbnYnKTtcblxuZXhwb3J0IGludGVyZmFjZSBBV1NBZGFwdGVyUHJvcHMge1xuICBhcnRpZmFjdFBhdGg/OiBzdHJpbmc7XG4gIGF1dG9EZXBsb3k/OiBib29sZWFuO1xuICBjZGtQcm9qZWN0UGF0aD86IHN0cmluZztcbiAgc3RhY2tOYW1lPzogc3RyaW5nO1xuICBlc2J1aWxkT3B0aW9ucz86IGFueTtcbiAgRlFETj86IHN0cmluZztcbiAgTE9HX1JFVEVOVElPTl9EQVlTPzogbnVtYmVyO1xuICBNRU1PUllfU0laRT86IG51bWJlcjtcbiAgZW52PzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkYXB0ZXIoe1xuICBhcnRpZmFjdFBhdGggPSAnYnVpbGQnLFxuICBhdXRvRGVwbG95ID0gZmFsc2UsXG4gIGNka1Byb2plY3RQYXRoID0gYCR7X19kaXJuYW1lfS9kZXBsb3kvaW5kZXguanNgLFxuICBzdGFja05hbWUgPSAnc3ZlbHRla2l0LWFkYXB0ZXItYXdzLXdlYmFwcCcsXG4gIGVzYnVpbGRPcHRpb25zID0ge30sXG4gIEZRRE4sXG4gIExPR19SRVRFTlRJT05fREFZUyxcbiAgTUVNT1JZX1NJWkUsXG4gIGVudiA9IHt9LFxufTogQVdTQWRhcHRlclByb3BzID0ge30pIHtcbiAgLyoqIEB0eXBlIHtpbXBvcnQoJ0BzdmVsdGVqcy9raXQnKS5BZGFwdGVyfSAqL1xuICByZXR1cm4ge1xuICAgIG5hbWU6ICdhZGFwdGVyLWF3c2NkaycsXG4gICAgYXN5bmMgYWRhcHQoYnVpbGRlcjogYW55KSB7XG4gICAgICBjb25zdCBlbnZpcm9ubWVudCA9IGNvbmZpZyh7IHBhdGg6IGpvaW4ocHJvY2Vzcy5jd2QoKSwgJy5lbnYnKSB9KTtcbiAgICAgIGVtcHR5RGlyU3luYyhhcnRpZmFjdFBhdGgpO1xuXG4gICAgICBjb25zdCBzdGF0aWNfZGlyZWN0b3J5ID0gam9pbihhcnRpZmFjdFBhdGgsICdhc3NldHMnKTtcbiAgICAgIGlmICghZXhpc3RzU3luYyhzdGF0aWNfZGlyZWN0b3J5KSkge1xuICAgICAgICBta2RpclN5bmMoc3RhdGljX2RpcmVjdG9yeSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByZXJlbmRlcmVkX2RpcmVjdG9yeSA9IGpvaW4oYXJ0aWZhY3RQYXRoLCAncHJlcmVuZGVyZWQnKTtcbiAgICAgIGlmICghZXhpc3RzU3luYyhwcmVyZW5kZXJlZF9kaXJlY3RvcnkpKSB7XG4gICAgICAgIG1rZGlyU3luYyhwcmVyZW5kZXJlZF9kaXJlY3RvcnksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZXJ2ZXJfZGlyZWN0b3J5ID0gam9pbihhcnRpZmFjdFBhdGgsICdzZXJ2ZXInKTtcbiAgICAgIGlmICghZXhpc3RzU3luYyhzZXJ2ZXJfZGlyZWN0b3J5KSkge1xuICAgICAgICBta2RpclN5bmMoc2VydmVyX2RpcmVjdG9yeSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICB9XG5cbiAgICAgIGJ1aWxkZXIubG9nLm1pbm9yKCdDb3B5aW5nIGFzc2V0IGZpbGVzLicpO1xuICAgICAgY29uc3QgY2xpZW50RmlsZXMgPSBhd2FpdCBidWlsZGVyLndyaXRlQ2xpZW50KHN0YXRpY19kaXJlY3RvcnkpO1xuXG4gICAgICBidWlsZGVyLmxvZy5taW5vcignQ29weWluZyBzZXJ2ZXIgZmlsZXMuJyk7XG4gICAgICBhd2FpdCBidWlsZGVyLndyaXRlU2VydmVyKGFydGlmYWN0UGF0aCk7XG4gICAgICBjb3B5RmlsZVN5bmMoYCR7X19kaXJuYW1lfS9sYW1iZGEvc2VydmVybGVzcy5qc2AsIGAke3NlcnZlcl9kaXJlY3Rvcnl9L19pbmRleC5qc2ApO1xuICAgICAgY29weUZpbGVTeW5jKGAke19fZGlybmFtZX0vbGFtYmRhL3NoaW1zLmpzYCwgYCR7c2VydmVyX2RpcmVjdG9yeX0vc2hpbXMuanNgKTtcblxuICAgICAgYnVpbGRlci5sb2cubWlub3IoJ0J1aWxkaW5nIEFXUyBMYW1iZGEgc2VydmVyIGZ1bmN0aW9uLicpO1xuICAgICAgZXNidWlsZC5idWlsZFN5bmMoe1xuICAgICAgICBlbnRyeVBvaW50czogW2Ake3NlcnZlcl9kaXJlY3Rvcnl9L19pbmRleC5qc2BdLFxuICAgICAgICBvdXRmaWxlOiBgJHtzZXJ2ZXJfZGlyZWN0b3J5fS9pbmRleC5qc2AsXG4gICAgICAgIGluamVjdDogW2pvaW4oYCR7c2VydmVyX2RpcmVjdG9yeX0vc2hpbXMuanNgKV0sXG4gICAgICAgIGV4dGVybmFsOiBbJ25vZGU6KicsIC4uLihlc2J1aWxkT3B0aW9ucz8uZXh0ZXJuYWwgPz8gW10pXSxcbiAgICAgICAgZm9ybWF0OiBlc2J1aWxkT3B0aW9ucz8uZm9ybWF0ID8/ICdjanMnLFxuICAgICAgICBidW5kbGU6IHRydWUsXG4gICAgICAgIHBsYXRmb3JtOiAnbm9kZScsXG4gICAgICAgIHRhcmdldDogZXNidWlsZE9wdGlvbnM/LnRhcmdldCA/PyAnbm9kZTE2JyxcbiAgICAgICAgdHJlZVNoYWtpbmc6IHRydWUsXG4gICAgICB9KTtcblxuICAgICAgYnVpbGRlci5sb2cubWlub3IoJ1ByZXJlbmRlcmluZyBzdGF0aWMgcGFnZXMuJyk7XG4gICAgICBjb25zdCBwcmVyZW5kZXJlZEZpbGVzID0gYXdhaXQgYnVpbGRlci53cml0ZVByZXJlbmRlcmVkKHByZXJlbmRlcmVkX2RpcmVjdG9yeSk7XG5cbiAgICAgIGJ1aWxkZXIubG9nLm1pbm9yKCdDbGVhbnVwIHByb2plY3QuJyk7XG4gICAgICB1bmxpbmtTeW5jKGAke3NlcnZlcl9kaXJlY3Rvcnl9L19pbmRleC5qc2ApO1xuICAgICAgdW5saW5rU3luYyhgJHthcnRpZmFjdFBhdGh9L2luZGV4LmpzYCk7XG5cbiAgICAgIGJ1aWxkZXIubG9nLm1pbm9yKCdFeHBvcnRpbmcgcm91dGVzLicpO1xuXG4gICAgICBjb25zdCByb3V0ZXMgPSBbXG4gICAgICAgIC4uLm5ldyBTZXQoXG4gICAgICAgICAgWy4uLmNsaWVudEZpbGVzLCAuLi5wcmVyZW5kZXJlZEZpbGVzXVxuICAgICAgICAgICAgLm1hcCgoeCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCB6ID0gZGlybmFtZSh4KTtcbiAgICAgICAgICAgICAgaWYgKHogPT09ICcuJykgcmV0dXJuIHg7XG4gICAgICAgICAgICAgIGlmICh6LmluY2x1ZGVzKCcvJykpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgIHJldHVybiBgJHt6fS8qYDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgICAgICksXG4gICAgICBdO1xuXG4gICAgICB3cml0ZUZpbGVTeW5jKGpvaW4oYXJ0aWZhY3RQYXRoLCAncm91dGVzLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkocm91dGVzKSk7XG5cbiAgICAgIGJ1aWxkZXIubG9nLm1pbm9yKCdEZXBsb3kgdXNpbmcgQVdTLUNESy4nKTtcbiAgICAgIGF1dG9EZXBsb3kgJiZcbiAgICAgICAgc3Bhd25TeW5jKFxuICAgICAgICAgICducHgnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdjZGsnLFxuICAgICAgICAgICAgJ2RlcGxveScsXG4gICAgICAgICAgICAnLS1hcHAnLFxuICAgICAgICAgICAgY2RrUHJvamVjdFBhdGgsXG4gICAgICAgICAgICAnKicsXG4gICAgICAgICAgICAnLS1yZXF1aXJlLWFwcHJvdmFsJyxcbiAgICAgICAgICAgICduZXZlcicsXG4gICAgICAgICAgICAnLS1vdXRwdXRzRmlsZScsXG4gICAgICAgICAgICBqb2luKF9fZGlybmFtZSwgJ2Nkay5vdXQnLCAnY2RrLWVudi12YXJzLmpzb24nKSxcbiAgICAgICAgICBdLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGN3ZDogX19kaXJuYW1lLFxuICAgICAgICAgICAgc3RkaW86IFtwcm9jZXNzLnN0ZGluLCBwcm9jZXNzLnN0ZG91dCwgcHJvY2Vzcy5zdGRlcnJdLFxuICAgICAgICAgICAgZW52OiBPYmplY3QuYXNzaWduKFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgUFJPSkVDVF9QQVRIOiBqb2luKHByb2Nlc3MuY3dkKCksICcuZW52JyksXG4gICAgICAgICAgICAgICAgU0VSVkVSX1BBVEg6IGpvaW4ocHJvY2Vzcy5jd2QoKSwgc2VydmVyX2RpcmVjdG9yeSksXG4gICAgICAgICAgICAgICAgU1RBVElDX1BBVEg6IGpvaW4ocHJvY2Vzcy5jd2QoKSwgc3RhdGljX2RpcmVjdG9yeSksXG4gICAgICAgICAgICAgICAgUFJFUkVOREVSRURfUEFUSDogam9pbihwcm9jZXNzLmN3ZCgpLCBwcmVyZW5kZXJlZF9kaXJlY3RvcnkpLFxuICAgICAgICAgICAgICAgIFJPVVRFUzogcm91dGVzLFxuICAgICAgICAgICAgICAgIFNUQUNLTkFNRTogc3RhY2tOYW1lLFxuICAgICAgICAgICAgICAgIEZRRE4sXG4gICAgICAgICAgICAgICAgTE9HX1JFVEVOVElPTl9EQVlTLFxuICAgICAgICAgICAgICAgIE1FTU9SWV9TSVpFLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBwcm9jZXNzLmVudixcbiAgICAgICAgICAgICAgZW52XG4gICAgICAgICAgICApLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmF3RGF0YSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJ2Nkay5vdXQnLCAnY2RrLWVudi12YXJzLmpzb24nKSkudG9TdHJpbmcoKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UocmF3RGF0YSk7XG4gICAgICAgIGNvbnN0IG91dCA9IE9iamVjdC5rZXlzKGRhdGEpLnJlZHVjZShcbiAgICAgICAgICAocCwgbikgPT4gKHtcbiAgICAgICAgICAgIC4uLnAsXG4gICAgICAgICAgICAuLi5PYmplY3Qua2V5cyhkYXRhW25dKVxuICAgICAgICAgICAgICAuZmlsdGVyKCh4OiBzdHJpbmcpID0+ICF4LmluY2x1ZGVzKCdFeHBvcnRzT3V0cHV0JykpXG4gICAgICAgICAgICAgIC5yZWR1Y2UoKHA6IGFueSwgeDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgcFt4LnRvVXBwZXJDYXNlKCldID0gZGF0YVtuXVt4XTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcDtcbiAgICAgICAgICAgICAgfSwge30pLFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIHt9XG4gICAgICAgICk7XG5cbiAgICAgICAgdXBkYXRlRG90ZW52KHsgLi4uZW52aXJvbm1lbnQucGFyc2VkLCAuLi5vdXQgfSk7XG4gICAgICAgIHVubGlua1N5bmMoam9pbihfX2Rpcm5hbWUsICdjZGsub3V0JywgJ2Nkay1lbnYtdmFycy5qc29uJykpO1xuICAgICAgfSBjYXRjaCB7fVxuXG4gICAgICBidWlsZGVyLmxvZy5taW5vcignQVdTLUNESyBkZXBsb3ltZW50IGRvbmUuJyk7XG4gICAgfSxcbiAgfTtcbn1cbiJdfQ==