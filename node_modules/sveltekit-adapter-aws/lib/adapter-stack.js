"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AWSAdapterStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_apigatewayv2_alpha_1 = require("@aws-cdk/aws-apigatewayv2-alpha");
const aws_apigatewayv2_integrations_alpha_1 = require("@aws-cdk/aws-apigatewayv2-integrations-alpha");
const dotenv_1 = require("dotenv");
class AWSAdapterStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        var _a, _b, _c;
        super(scope, id, props);
        const routes = ((_a = process.env.ROUTES) === null || _a === void 0 ? void 0 : _a.split(',')) || [];
        const projectPath = process.env.PROJECT_PATH;
        const serverPath = process.env.SERVER_PATH;
        const staticPath = process.env.STATIC_PATH;
        const prerenderedPath = process.env.PRERENDERED_PATH;
        const logRetention = parseInt(process.env.LOG_RETENTION_DAYS) || 7;
        const memorySize = parseInt(process.env.MEMORY_SIZE) || 128;
        const environment = (0, dotenv_1.config)({ path: projectPath });
        const [zoneName, TLD] = ((_b = process.env.FQDN) === null || _b === void 0 ? void 0 : _b.split('.').slice(-2)) || [];
        const domainName = `${zoneName}.${TLD}`;
        this.serverHandler = new aws_cdk_lib_1.aws_lambda.Function(this, 'LambdaServerFunctionHandler', {
            code: new aws_cdk_lib_1.aws_lambda.AssetCode(serverPath),
            handler: 'index.handler',
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.NODEJS_16_X,
            timeout: aws_cdk_lib_1.Duration.minutes(15),
            memorySize,
            logRetention,
            environment: Object.assign({}, environment.parsed),
        });
        (_c = props.serverHandlerPolicies) === null || _c === void 0 ? void 0 : _c.forEach((policy) => this.serverHandler.addToRolePolicy(policy));
        this.httpApi = new aws_apigatewayv2_alpha_1.HttpApi(this, 'API', {
            corsPreflight: {
                allowHeaders: ['*'],
                allowMethods: [aws_apigatewayv2_alpha_1.CorsHttpMethod.ANY],
                allowOrigins: ['*'],
                maxAge: aws_cdk_lib_1.Duration.days(1),
            },
            defaultIntegration: new aws_apigatewayv2_integrations_alpha_1.HttpLambdaIntegration('LambdaServerIntegration', this.serverHandler, {
                payloadFormatVersion: aws_apigatewayv2_alpha_1.PayloadFormatVersion.VERSION_1_0,
            }),
        });
        this.bucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 'StaticContentBucket', {
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
            autoDeleteObjects: true,
        });
        if (process.env.FQDN) {
            this.hostedZone = aws_cdk_lib_1.aws_route53.HostedZone.fromLookup(this, 'HostedZone', {
                domainName,
            });
            this.certificate = new aws_cdk_lib_1.aws_certificatemanager.DnsValidatedCertificate(this, 'DnsValidatedCertificate', {
                domainName: process.env.FQDN,
                hostedZone: this.hostedZone,
                region: 'us-east-1',
            });
        }
        const distribution = new aws_cdk_lib_1.aws_cloudfront.Distribution(this, 'CloudFrontDistribution', {
            priceClass: aws_cdk_lib_1.aws_cloudfront.PriceClass.PRICE_CLASS_100,
            enabled: true,
            defaultRootObject: '',
            sslSupportMethod: aws_cdk_lib_1.aws_cloudfront.SSLMethod.SNI,
            domainNames: process.env.FQDN ? [process.env.FQDN] : [],
            certificate: process.env.FQDN
                ? aws_cdk_lib_1.aws_certificatemanager.Certificate.fromCertificateArn(this, 'DomainCertificate', this.certificate.certificateArn)
                : undefined,
            defaultBehavior: {
                compress: true,
                origin: new aws_cdk_lib_1.aws_cloudfront_origins.HttpOrigin(aws_cdk_lib_1.Fn.select(1, aws_cdk_lib_1.Fn.split('://', this.httpApi.apiEndpoint)), {
                    protocolPolicy: aws_cdk_lib_1.aws_cloudfront.OriginProtocolPolicy.HTTPS_ONLY,
                }),
                viewerProtocolPolicy: aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                allowedMethods: aws_cdk_lib_1.aws_cloudfront.AllowedMethods.ALLOW_ALL,
                originRequestPolicy: new aws_cdk_lib_1.aws_cloudfront.OriginRequestPolicy(this, 'OriginRequestPolicy', {
                    cookieBehavior: aws_cdk_lib_1.aws_cloudfront.OriginRequestCookieBehavior.all(),
                    queryStringBehavior: aws_cdk_lib_1.aws_cloudfront.OriginRequestQueryStringBehavior.all(),
                    headerBehavior: aws_cdk_lib_1.aws_cloudfront.OriginRequestHeaderBehavior.allowList('Origin', 'Accept-Charset', 'Accept', 'Access-Control-Request-Method', 'Access-Control-Request-Headers', 'Referer', 'Accept-Language', 'Accept-Datetime'),
                }),
                cachePolicy: aws_cdk_lib_1.aws_cloudfront.CachePolicy.CACHING_DISABLED,
            },
        });
        const s3Origin = new aws_cdk_lib_1.aws_cloudfront_origins.S3Origin(this.bucket, {});
        routes.forEach((route) => {
            distribution.addBehavior(route, s3Origin, {
                viewerProtocolPolicy: aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                allowedMethods: aws_cdk_lib_1.aws_cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                originRequestPolicy: aws_cdk_lib_1.aws_cloudfront.OriginRequestPolicy.USER_AGENT_REFERER_HEADERS,
                cachePolicy: aws_cdk_lib_1.aws_cloudfront.CachePolicy.CACHING_OPTIMIZED,
            });
        });
        if (process.env.FQDN) {
            new aws_cdk_lib_1.aws_route53.ARecord(this, 'ARecord', {
                recordName: process.env.FQDN,
                target: aws_cdk_lib_1.aws_route53.RecordTarget.fromAlias(new aws_cdk_lib_1.aws_route53_targets.CloudFrontTarget(distribution)),
                zone: this.hostedZone,
            });
        }
        new aws_cdk_lib_1.aws_s3_deployment.BucketDeployment(this, 'StaticContentDeployment', {
            destinationBucket: this.bucket,
            sources: [aws_cdk_lib_1.aws_s3_deployment.Source.asset(staticPath), aws_cdk_lib_1.aws_s3_deployment.Source.asset(prerenderedPath)],
            retainOnDelete: false,
            prune: true,
            distribution,
            distributionPaths: ['/*'],
        });
        new aws_cdk_lib_1.CfnOutput(this, 'appUrl', {
            value: process.env.FQDN ? `https://${process.env.FQDN}` : `https://${distribution.domainName}`,
        });
        new aws_cdk_lib_1.CfnOutput(this, 'stackName', { value: id });
    }
}
exports.AWSAdapterStack = AWSAdapterStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFkYXB0ZXItc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsNkNBZXFCO0FBQ3JCLDRFQUEwRztBQUMxRyxzR0FBcUY7QUFDckYsbUNBQWdDO0FBVWhDLE1BQWEsZUFBZ0IsU0FBUSxtQkFBSztJQU94QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTJCOztRQUNuRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLE1BQU0sR0FBRyxDQUFBLE1BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLDBDQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSSxFQUFFLENBQUM7UUFDcEQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7UUFDN0MsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztRQUNyRCxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFZLENBQUMsSUFBSSxHQUFHLENBQUM7UUFDN0QsTUFBTSxXQUFXLEdBQUcsSUFBQSxlQUFNLEVBQUMsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNsRCxNQUFNLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUEsTUFBQSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksMENBQUUsS0FBSyxDQUFD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QUU7WUFDNUIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsWUFBWSxDQUFDLFVBQVUsRUFBRTtTQUMvRixDQUFDLENBQUM7UUFFSCxJQUFJLHVCQUFTLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELENBQUM7Q0FDRjtBQXZJRCwwQ0F1SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIFN0YWNrUHJvcHMsXG4gIFN0YWNrLFxuICBGbixcbiAgUmVtb3ZhbFBvbGljeSxcbiAgRHVyYXRpb24sXG4gIENmbk91dHB1dCxcbiAgYXdzX2xhbWJkYSxcbiAgYXdzX3MzLFxuICBhd3NfczNfZGVwbG95bWVudCxcbiAgYXdzX2Nsb3VkZnJvbnRfb3JpZ2lucyxcbiAgYXdzX2NlcnRpZmljYXRlbWFuYWdlcixcbiAgYXdzX3JvdXRlNTMsXG4gIGF3c19yb3V0ZTUzX3RhcmdldHMsXG4gIGF3c19jbG91ZGZyb250LFxufSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb3JzSHR0cE1ldGhvZCwgSHR0cEFwaSwgSUh0dHBBcGksIFBheWxvYWRGb3JtYXRWZXJzaW9uIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hbHBoYSc7XG5pbXBvcnQgeyBIdHRwTGFtYmRhSW50ZWdyYXRpb24gfSBmcm9tICdAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyLWludGVncmF0aW9ucy1hbHBoYSc7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHsgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVdTQWRhcHRlclN0YWNrUHJvcHMgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgRlFETjogc3RyaW5nO1xuICBhY2NvdW50Pzogc3RyaW5nO1xuICByZWdpb24/OiBzdHJpbmc7XG4gIHNlcnZlckhhbmRsZXJQb2xpY2llcz86IFBvbGljeVN0YXRlbWVudFtdO1xufVxuXG5leHBvcnQgY2xhc3MgQVdTQWRhcHRlclN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICBidWNrZXQ6IGF3c19zMy5JQnVja2V0O1xuICBzZXJ2ZXJIYW5kbGVyOiBhd3NfbGFtYmRhLklGdW5jdGlvbjtcbiAgaHR0cEFwaTogSUh0dHBBcGk7XG4gIGhvc3RlZFpvbmU6IGF3c19yb3V0ZTUzLklIb3N0ZWRab25lO1xuICBjZXJ0aWZpY2F0ZTogYXdzX2NlcnRpZmljYXRlbWFuYWdlci5JQ2VydGlmaWNhdGU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEFXU0FkYXB0ZXJTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCByb3V0ZXMgPSBwcm9jZXNzLmVudi5ST1VURVM/LnNwbGl0KCcsJykgfHwgW107XG4gICAgY29uc3QgcHJvamVjdFBhdGggPSBwcm9jZXNzLmVudi5QUk9KRUNUX1BBVEg7XG4gICAgY29uc3Qgc2VydmVyUGF0aCA9IHByb2Nlc3MuZW52LlNFUlZFUl9QQVRIO1xuICAgIGNvbnN0IHN0YXRpY1BhdGggPSBwcm9jZXNzLmVudi5TVEFUSUNfUEFUSDtcbiAgICBjb25zdCBwcmVyZW5kZXJlZFBhdGggPSBwcm9jZXNzLmVudi5QUkVSRU5ERVJFRF9QQVRIO1xuICAgIGNvbnN0IGxvZ1JldGVudGlvbiA9IHBhcnNlSW50KHByb2Nlc3MuZW52LkxPR19SRVRFTlRJT05fREFZUyEpIHx8IDc7XG4gICAgY29uc3QgbWVtb3J5U2l6ZSA9IHBhcnNlSW50KHByb2Nlc3MuZW52Lk1FTU9SWV9TSVpFISkgfHwgMTI4O1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gY29uZmlnKHsgcGF0aDogcHJvamVjdFBhdGggfSk7XG4gICAgY29uc3QgW3pvbmVOYW1lLCBUTERdID0gcHJvY2Vzcy5lbnYuRlFETj8uc3BsaXQoJy4nKS5zbGljZSgtMikgfHwgW107XG4gICAgY29uc3QgZG9tYWluTmFtZSA9IGAke3pvbmVOYW1lfS4ke1RMRH1gO1xuXG4gICAgdGhpcy5zZXJ2ZXJIYW5kbGVyID0gbmV3IGF3c19sYW1iZGEuRnVuY3Rpb24odGhpcywgJ0xhbWJkYVNlcnZlckZ1bmN0aW9uSGFuZGxlcicsIHtcbiAgICAgIGNvZGU6IG5ldyBhd3NfbGFtYmRhLkFzc2V0Q29kZShzZXJ2ZXJQYXRoISksXG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBhd3NfbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE2X1gsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemUsXG4gICAgICBsb2dSZXRlbnRpb24sXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAuLi5lbnZpcm9ubWVudC5wYXJzZWQsXG4gICAgICB9IGFzIGFueSxcbiAgICB9KTtcblxuICAgIHByb3BzLnNlcnZlckhhbmRsZXJQb2xpY2llcz8uZm9yRWFjaCgocG9saWN5KSA9PiB0aGlzLnNlcnZlckhhbmRsZXIuYWRkVG9Sb2xlUG9saWN5KHBvbGljeSkpO1xuXG4gICAgdGhpcy5odHRwQXBpID0gbmV3IEh0dHBBcGkodGhpcywgJ0FQSScsIHtcbiAgICAgIGNvcnNQcmVmbGlnaHQ6IHtcbiAgICAgICAgYWxsb3dIZWFkZXJzOiBbJyonXSxcbiAgICAgICAgYWxsb3dNZXRob2RzOiBbQ29yc0h0dHBNZXRob2QuQU5ZXSxcbiAgICAgICAgYWxsb3dPcmlnaW5zOiBbJyonXSxcbiAgICAgICAgbWF4QWdlOiBEdXJhdGlvbi5kYXlzKDEpLFxuICAgICAgfSxcbiAgICAgIGRlZmF1bHRJbnRlZ3JhdGlvbjogbmV3IEh0dHBMYW1iZGFJbnRlZ3JhdGlvbignTGFtYmRhU2VydmVySW50ZWdyYXRpb24nLCB0aGlzLnNlcnZlckhhbmRsZXIsIHtcbiAgICAgICAgcGF5bG9hZEZvcm1hdFZlcnNpb246IFBheWxvYWRGb3JtYXRWZXJzaW9uLlZFUlNJT05fMV8wLFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICB0aGlzLmJ1Y2tldCA9IG5ldyBhd3NfczMuQnVja2V0KHRoaXMsICdTdGF0aWNDb250ZW50QnVja2V0Jywge1xuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsXG4gICAgfSk7XG5cbiAgICBpZiAocHJvY2Vzcy5lbnYuRlFETikge1xuICAgICAgdGhpcy5ob3N0ZWRab25lID0gYXdzX3JvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsICdIb3N0ZWRab25lJywge1xuICAgICAgICBkb21haW5OYW1lLFxuICAgICAgfSkgYXMgYXdzX3JvdXRlNTMuSG9zdGVkWm9uZTtcblxuICAgICAgdGhpcy5jZXJ0aWZpY2F0ZSA9IG5ldyBhd3NfY2VydGlmaWNhdGVtYW5hZ2VyLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlKHRoaXMsICdEbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZScsIHtcbiAgICAgICAgZG9tYWluTmFtZTogcHJvY2Vzcy5lbnYuRlFETiEsXG4gICAgICAgIGhvc3RlZFpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGRpc3RyaWJ1dGlvbiA9IG5ldyBhd3NfY2xvdWRmcm9udC5EaXN0cmlidXRpb24odGhpcywgJ0Nsb3VkRnJvbnREaXN0cmlidXRpb24nLCB7XG4gICAgICBwcmljZUNsYXNzOiBhd3NfY2xvdWRmcm9udC5QcmljZUNsYXNzLlBSSUNFX0NMQVNTXzEwMCxcbiAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICBkZWZhdWx0Um9vdE9iamVjdDogJycsXG4gICAgICBzc2xTdXBwb3J0TWV0aG9kOiBhd3NfY2xvdWRmcm9udC5TU0xNZXRob2QuU05JLFxuICAgICAgZG9tYWluTmFtZXM6IHByb2Nlc3MuZW52LkZRRE4gPyBbcHJvY2Vzcy5lbnYuRlFETiFdIDogW10sXG4gICAgICBjZXJ0aWZpY2F0ZTogcHJvY2Vzcy5lbnYuRlFETlxuICAgICAgICA/IGF3c19jZXJ0aWZpY2F0ZW1hbmFnZXIuQ2VydGlmaWNhdGUuZnJvbUNlcnRpZmljYXRlQXJuKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICdEb21haW5DZXJ0aWZpY2F0ZScsXG4gICAgICAgICAgICB0aGlzLmNlcnRpZmljYXRlLmNlcnRpZmljYXRlQXJuXG4gICAgICAgICAgKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIGRlZmF1bHRCZWhhdmlvcjoge1xuICAgICAgICBjb21wcmVzczogdHJ1ZSxcbiAgICAgICAgb3JpZ2luOiBuZXcgYXdzX2Nsb3VkZnJvbnRfb3JpZ2lucy5IdHRwT3JpZ2luKEZuLnNlbGVjdCgxLCBGbi5zcGxpdCgnOi8vJywgdGhpcy5odHRwQXBpLmFwaUVuZHBvaW50KSksIHtcbiAgICAgICAgICBwcm90b2NvbFBvbGljeTogYXdzX2Nsb3VkZnJvbnQuT3JpZ2luUHJvdG9jb2xQb2xpY3kuSFRUUFNfT05MWSxcbiAgICAgICAgfSksXG4gICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5OiBhd3NfY2xvdWRmcm9udC5WaWV3ZXJQcm90b2NvbFBvbGljeS5SRURJUkVDVF9UT19IVFRQUyxcbiAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGF3c19jbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0FMTCxcbiAgICAgICAgb3JpZ2luUmVxdWVzdFBvbGljeTogbmV3IGF3c19jbG91ZGZyb250Lk9yaWdpblJlcXVlc3RQb2xpY3kodGhpcywgJ09yaWdpblJlcXVlc3RQb2xpY3knLCB7XG4gICAgICAgICAgY29va2llQmVoYXZpb3I6IGF3c19jbG91ZGZyb250Lk9yaWdpblJlcXVlc3RDb29raWVCZWhhdmlvci5hbGwoKSxcbiAgICAgICAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOiBhd3NfY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0UXVlcnlTdHJpbmdCZWhhdmlvci5hbGwoKSxcbiAgICAgICAgICBoZWFkZXJCZWhhdmlvcjogYXdzX2Nsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdEhlYWRlckJlaGF2aW9yLmFsbG93TGlzdChcbiAgICAgICAgICAgICdPcmlnaW4nLFxuICAgICAgICAgICAgJ0FjY2VwdC1DaGFyc2V0JyxcbiAgICAgICAgICAgICdBY2NlcHQnLFxuICAgICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLVJlcXVlc3QtTWV0aG9kJyxcbiAgICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1SZXF1ZXN0LUhlYWRlcnMnLFxuICAgICAgICAgICAgJ1JlZmVyZXInLFxuICAgICAgICAgICAgJ0FjY2VwdC1MYW5ndWFnZScsXG4gICAgICAgICAgICAnQWNjZXB0LURhdGV0aW1lJ1xuICAgICAgICAgICksXG4gICAgICAgIH0pLFxuICAgICAgICBjYWNoZVBvbGljeTogYXdzX2Nsb3VkZnJvbnQuQ2FjaGVQb2xpY3kuQ0FDSElOR19ESVNBQkxFRCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBzM09yaWdpbiA9IG5ldyBhd3NfY2xvdWRmcm9udF9vcmlnaW5zLlMzT3JpZ2luKHRoaXMuYnVja2V0LCB7fSk7XG4gICAgcm91dGVzLmZvckVhY2goKHJvdXRlKSA9PiB7XG4gICAgICBkaXN0cmlidXRpb24uYWRkQmVoYXZpb3Iocm91dGUsIHMzT3JpZ2luLCB7XG4gICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5OiBhd3NfY2xvdWRmcm9udC5WaWV3ZXJQcm90b2NvbFBvbGljeS5SRURJUkVDVF9UT19IVFRQUyxcbiAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGF3c19jbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgIG9yaWdpblJlcXVlc3RQb2xpY3k6IGF3c19jbG91ZGZyb250Lk9yaWdpblJlcXVlc3RQb2xpY3kuVVNFUl9BR0VOVF9SRUZFUkVSX0hFQURFUlMsXG4gICAgICAgIGNhY2hlUG9saWN5OiBhd3NfY2xvdWRmcm9udC5DYWNoZVBvbGljeS5DQUNISU5HX09QVElNSVpFRCxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaWYgKHByb2Nlc3MuZW52LkZRRE4pIHtcbiAgICAgIG5ldyBhd3Nfcm91dGU1My5BUmVjb3JkKHRoaXMsICdBUmVjb3JkJywge1xuICAgICAgICByZWNvcmROYW1lOiBwcm9jZXNzLmVudi5GUUROLFxuICAgICAgICB0YXJnZXQ6IGF3c19yb3V0ZTUzLlJlY29yZFRhcmdldC5mcm9tQWxpYXMobmV3IGF3c19yb3V0ZTUzX3RhcmdldHMuQ2xvdWRGcm9udFRhcmdldChkaXN0cmlidXRpb24pKSxcbiAgICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbmV3IGF3c19zM19kZXBsb3ltZW50LkJ1Y2tldERlcGxveW1lbnQodGhpcywgJ1N0YXRpY0NvbnRlbnREZXBsb3ltZW50Jywge1xuICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IHRoaXMuYnVja2V0LFxuICAgICAgc291cmNlczogW2F3c19zM19kZXBsb3ltZW50LlNvdXJjZS5hc3NldChzdGF0aWNQYXRoISksIGF3c19zM19kZXBsb3ltZW50LlNvdXJjZS5hc3NldChwcmVyZW5kZXJlZFBhdGghKV0sXG4gICAgICByZXRhaW5PbkRlbGV0ZTogZmFsc2UsXG4gICAgICBwcnVuZTogdHJ1ZSxcbiAgICAgIGRpc3RyaWJ1dGlvbixcbiAgICAgIGRpc3RyaWJ1dGlvblBhdGhzOiBbJy8qJ10sXG4gICAgfSk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsICdhcHBVcmwnLCB7XG4gICAgICB2YWx1ZTogcHJvY2Vzcy5lbnYuRlFETiA/IGBodHRwczovLyR7cHJvY2Vzcy5lbnYuRlFETn1gIDogYGh0dHBzOi8vJHtkaXN0cmlidXRpb24uZG9tYWluTmFtZX1gLFxuICAgIH0pO1xuXG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCAnc3RhY2tOYW1lJywgeyB2YWx1ZTogaWQgfSk7XG4gIH1cbn1cbiJdfQ==